syntax = "proto3";

package ebu.v1;

option go_package = "github.com/jilio/lookhere/gen/ebu/v1;ebuv1";

import "google/protobuf/timestamp.proto";

// EventService handles event streaming
service EventService {
  // SaveEvent saves a single event to storage
  rpc SaveEvent(SaveEventRequest) returns (SaveEventResponse);

  // LoadEvents loads events from storage within a position range
  rpc LoadEvents(LoadEventsRequest) returns (LoadEventsResponse);

  // GetPosition returns the current position (highest event number)
  rpc GetPosition(GetPositionRequest) returns (GetPositionResponse);

  // SaveSubscriptionPosition saves a subscription's position for resumable subscriptions
  rpc SaveSubscriptionPosition(SaveSubscriptionPositionRequest) returns (SaveSubscriptionPositionResponse);

  // LoadSubscriptionPosition loads a subscription's saved position
  rpc LoadSubscriptionPosition(LoadSubscriptionPositionRequest) returns (LoadSubscriptionPositionResponse);

  // ReportTelemetry accepts a stream of telemetry batches from the client
  rpc ReportTelemetry(stream TelemetryBatch) returns (TelemetryResponse);
}

// StoredEvent represents an event in persistent storage
message StoredEvent {
  int64 position = 1;
  string type = 2;
  bytes data = 3;
  google.protobuf.Timestamp timestamp = 4;
}

// SaveEvent request/response
message SaveEventRequest {
  StoredEvent event = 1;
}

message SaveEventResponse {
  int64 position = 1;
}

// LoadEvents request/response
message LoadEventsRequest {
  int64 from = 1;
  int64 to = 2;
}

message LoadEventsResponse {
  repeated StoredEvent events = 1;
}

// GetPosition request/response
message GetPositionRequest {}

message GetPositionResponse {
  int64 position = 1;
}

// SaveSubscriptionPosition request/response
message SaveSubscriptionPositionRequest {
  string subscription_id = 1;
  int64 position = 2;
}

message SaveSubscriptionPositionResponse {}

// LoadSubscriptionPosition request/response
message LoadSubscriptionPositionRequest {
  string subscription_id = 1;
}

message LoadSubscriptionPositionResponse {
  int64 position = 1;
}

// Telemetry messages for observability

// TelemetryBatch contains a batch of telemetry metrics
message TelemetryBatch {
  repeated TelemetryMetric metrics = 1;
}

// TelemetryMetric represents a single observability metric from EBU
message TelemetryMetric {
  google.protobuf.Timestamp timestamp = 1;
  oneof metric {
    PublishMetric publish = 2;
    HandlerMetric handler = 3;
    PersistMetric persist = 4;
  }
}

// PublishMetric tracks event publishing
message PublishMetric {
  string event_type = 1;
  int64 duration_ns = 2; // Duration in nanoseconds
}

// HandlerMetric tracks event handler execution
message HandlerMetric {
  string event_type = 1;
  bool async = 2; // Whether handler was async
  int64 duration_ns = 3; // Duration in nanoseconds
  string error = 4; // Error message if handler failed (empty if success)
}

// PersistMetric tracks event persistence operations
message PersistMetric {
  string event_type = 1;
  int64 position = 2; // Event position in storage
  int64 duration_ns = 3; // Duration in nanoseconds
  string error = 4; // Error message if persist failed (empty if success)
}

// TelemetryResponse acknowledges telemetry receipt
message TelemetryResponse {
  int64 received_count = 1; // Number of metrics received
}
