syntax = "proto3";

package ebu.v1;

option go_package = "github.com/jilio/lookhere/gen/ebu/v1;ebuv1";

import "google/protobuf/timestamp.proto";

// EventService handles event streaming and telemetry
service EventService {
  // SaveEvent saves a single event to storage
  rpc SaveEvent(SaveEventRequest) returns (SaveEventResponse);

  // SaveEvents saves multiple events to storage (batched)
  rpc SaveEvents(SaveEventsRequest) returns (SaveEventsResponse);

  // LoadEvents loads events from storage within a position range
  rpc LoadEvents(LoadEventsRequest) returns (LoadEventsResponse);

  // GetPosition returns the current position (highest event number)
  rpc GetPosition(GetPositionRequest) returns (GetPositionResponse);

  // SaveSubscriptionPosition saves a subscription's position for resumable subscriptions
  rpc SaveSubscriptionPosition(SaveSubscriptionPositionRequest) returns (SaveSubscriptionPositionResponse);

  // LoadSubscriptionPosition loads a subscription's saved position
  rpc LoadSubscriptionPosition(LoadSubscriptionPositionRequest) returns (LoadSubscriptionPositionResponse);

  // ExportTrace accepts OTLP trace data (compatible with OpenTelemetry collectors)
  // This follows the OTLP/HTTP protocol for trace export
  rpc ExportTrace(ExportTraceServiceRequest) returns (ExportTraceServiceResponse);
}

// StoredEvent represents an event in persistent storage
message StoredEvent {
  int64 position = 1;
  string type = 2;
  bytes data = 3;
  google.protobuf.Timestamp timestamp = 4;
}

// SaveEvent request/response
message SaveEventRequest {
  StoredEvent event = 1;
}

message SaveEventResponse {
  int64 position = 1;
}

// SaveEvents request/response (batched)
message SaveEventsRequest {
  repeated StoredEvent events = 1;
}

message SaveEventsResponse {
  repeated int64 positions = 1;  // One position per event
}

// LoadEvents request/response
message LoadEventsRequest {
  int64 from = 1;
  int64 to = 2;
}

message LoadEventsResponse {
  repeated StoredEvent events = 1;
}

// GetPosition request/response
message GetPositionRequest {}

message GetPositionResponse {
  int64 position = 1;
}

// SaveSubscriptionPosition request/response
message SaveSubscriptionPositionRequest {
  string subscription_id = 1;
  int64 position = 2;
}

message SaveSubscriptionPositionResponse {}

// LoadSubscriptionPosition request/response
message LoadSubscriptionPositionRequest {
  string subscription_id = 1;
}

message LoadSubscriptionPositionResponse {
  int64 position = 1;
}

// OTLP Trace Export Messages
// Simplified OTLP protocol for EBU telemetry

message ExportTraceServiceRequest {
  repeated ResourceSpans resource_spans = 1;
}

message ExportTraceServiceResponse {
  ExportTracePartialSuccess partial_success = 1;
}

message ExportTracePartialSuccess {
  int64 rejected_spans = 1;
  string error_message = 2;
}

message ResourceSpans {
  Resource resource = 1;
  repeated ScopeSpans scope_spans = 2;
}

message Resource {
  repeated KeyValue attributes = 1;
}

message ScopeSpans {
  InstrumentationScope scope = 1;
  repeated Span spans = 2;
}

message InstrumentationScope {
  string name = 1;
  string version = 2;
}

message Span {
  bytes trace_id = 1; // 16 bytes
  bytes span_id = 2; // 8 bytes
  bytes parent_span_id = 3; // 8 bytes (optional)

  string name = 4;
  SpanKind kind = 5;
  fixed64 start_time_unix_nano = 6;
  fixed64 end_time_unix_nano = 7;

  repeated KeyValue attributes = 8;
  Status status = 9;
}

enum SpanKind {
  SPAN_KIND_UNSPECIFIED = 0;
  SPAN_KIND_INTERNAL = 1;
  SPAN_KIND_SERVER = 2;
  SPAN_KIND_CLIENT = 3;
  SPAN_KIND_PRODUCER = 4;
  SPAN_KIND_CONSUMER = 5;
}

message Status {
  StatusCode code = 1;
  string message = 2;
}

enum StatusCode {
  STATUS_CODE_UNSET = 0;
  STATUS_CODE_OK = 1;
  STATUS_CODE_ERROR = 2;
}

message KeyValue {
  string key = 1;
  AnyValue value = 2;
}

message AnyValue {
  oneof value {
    string string_value = 1;
    bool bool_value = 2;
    int64 int_value = 3;
    double double_value = 4;
  }
}
